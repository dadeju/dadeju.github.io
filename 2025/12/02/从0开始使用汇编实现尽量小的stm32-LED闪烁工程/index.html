<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="GaoSheng">
    
    <title>
        
            从0开始使用汇编实现stm32 LED闪烁工程 |
        
        GaoSheng
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/font/css/fontawesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/font/css/regular.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/font/css/solid.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/font/css/brands.min.css">
    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"zh-CN"}
    KEEP.theme_config = {"base_info":{"primary_color":"#0066cc","title":"GaoSheng","author":"GaoSheng","avatar":null,"logo":null,"favicon":null},"menu":{"home":"/","archives":"/archives"},"first_screen":{"enable":true,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"我也许不知道答案，但我知道怎么找到答案","hitokoto":false},"social_contact":{"enable":true,"links":{"weixin":"img | ./images/wxcode.png","email":null}},"scroll":{"progress_bar":false,"percent":false,"hide_header":true},"home":{"announcement":null,"category":false,"tag":false,"post_datetime":"updated"},"post":{"author_badge":{"enable":true,"level_badge":true,"custom_badge":["One","Two","Three"]},"word_count":{"wordcount":false,"min2read":false},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":false,"share":false,"reward":{"enable":false,"img_link":null,"text":null,"icon":null}},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"toc":{"enable":false,"number":false,"expand_all":false,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":false,"site_uv":false,"site_pv":false,"page_pv":false}},"local_search":{"enable":true,"preload":false},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.39"},"waline":{"server_url":null,"reaction":false,"version":"3.3.2"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":false},"lazyload":{"enable":false},"cdn":{"enable":true,"provider":"cdnjs"},"pjax":{"enable":false},"footer":{"since":2020,"word_count":false,"site_deploy":{"enable":true,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"root":"","source_data":{},"version":"4.2.5"}
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"}
    KEEP.language_code_block = {"copy":"复制代码","copied":"已复制","fold":"折叠代码块","folded":"已折叠"}
    KEEP.language_copy_copyright = {"copy":"复制版权信息","copied":"已复制","title":"原文标题","author":"原文作者","link":"原文链接"}
  </script>
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
            <a class="site-name border-box" href="/">
               GaoSheng
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                首页
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                归档
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                            首页
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                            归档
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        从0开始使用汇编实现stm32 LED闪烁工程
                    </div>
                

                
                    <div class="post-header border-box">
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">GaoSheng</span>
                                
                                    <span class="author-badge">Lv5</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2025-12-02 22:53:04</span>
            </span>

            
                <span class="meta-info-item post-update-date">
                    <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                    <span class="datetime" data-updated="Sun Dec 14 2025 10:35:33 GMT+0800">2025-12-14 10:35:33</span>
                </span>
            
        

        

        

        
        
        
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <h1 id="最小STM32-LED闪烁系统详解（纯汇编实现）"><a href="#最小STM32-LED闪烁系统详解（纯汇编实现）" class="headerlink" title="最小STM32 LED闪烁系统详解（纯汇编实现）"></a>最小STM32 LED闪烁系统详解（纯汇编实现）</h1><p>本文会简要介绍如何用纯ARM汇编语言编写一个最小化的STM32 LED闪烁程序。展示了嵌入式系统的最基本结构，包括启动文件、链接脚本、主程序以及构建过程。</p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ol>
<li><a href="#%E9%A1%B9%E7%9B%AE%E6%A6%82%E8%BF%B0">项目概述</a></li>
<li><a href="#%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3">启动文件详解</a></li>
<li><a href="#%E4%B8%BB%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90">主程序分析</a></li>
<li><a href="#%E9%93%BE%E6%8E%A5%E8%84%9A%E6%9C%AC%E8%A7%A3%E6%9E%90">链接脚本解析</a></li>
<li><a href="#makefile%E6%9E%84%E5%BB%BA%E7%B3%BB%E7%BB%9F">Makefile构建系统</a></li>
<li><a href="#map%E6%96%87%E4%BB%B6%E8%A7%A3%E8%AF%BB">MAP文件解读</a></li>
<li><a href="#%E6%80%BB%E7%BB%93">总结</a><br><img   src="https://dadeju.github.io/picx-images-hosting/image.9o08xd7s7s.png"  alt="image"></li>
</ol>
<h2 id="项目概述"><a href="#项目概述" class="headerlink" title="项目概述"></a>项目概述</h2><p>这个项目实现了STM32F40上PB2引脚连接的LED灯的简单闪烁功能。整个程序完全使用ARM汇编语言编写，不依赖任何C库或其他高级语言组件。相信这个工程会让初学者对STM32会更加系统性的理解，对于老鸟说不定也会有所得。</p>
<h2 id="启动文件详解"><a href="#启动文件详解" class="headerlink" title="启动文件详解"></a>启动文件详解</h2><p>启动文件[startup.s]是嵌入式系统运行的第一个代码，负责初始化硬件环境并跳转到主程序。</p>
<h3 id="向量表-Vector-Table"><a href="#向量表-Vector-Table" class="headerlink" title="向量表(Vector Table)"></a>向量表(Vector Table)</h3><p>向量表是位于程序起始位置的一组指针，指向各种异常和中断处理程序：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.section .isr_vector</span><br><span class="line">.align 2</span><br><span class="line">.globl __isr_vector</span><br><span class="line">__isr_vector:</span><br><span class="line">    .long   __StackTop            /* 栈顶指针 */</span><br><span class="line">    .long   Reset_Handler         /* 复位处理程序 */</span><br><span class="line">    .long   NMI_Handler           /* 不可屏蔽中断处理程序 */</span><br><span class="line">    .long   HardFault_Handler     /* 硬件故障处理程序 */</span><br><span class="line">    /* 其他异常处理程序... */</span><br></pre></td></tr></table></figure>

<p>第一个条目<code>__StackTop</code>是栈顶地址，当处理器复位时，它会被加载到主堆栈指针(MSP)中。第二个条目<code>Reset_Handler</code>是复位后执行的第一个程序入口点。上面的<code>.align 2</code> 是指按 2^2 &#x3D; 4 字节边界对齐</p>
<h3 id="栈和堆定义"><a href="#栈和堆定义" class="headerlink" title="栈和堆定义"></a>栈和堆定义</h3><p>手动定义栈和堆空间：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/* 栈空间定义 */</span><br><span class="line">.section .stack</span><br><span class="line">.align 3</span><br><span class="line">.equ Stack_Size, 0x400</span><br><span class="line">.globl __StackTop</span><br><span class="line">.globl __StackLimit</span><br><span class="line">__StackLimit:</span><br><span class="line">.space Stack_Size</span><br><span class="line">__StackTop:</span><br></pre></td></tr></table></figure>

<p>这里我们为栈分配了0x400(1KB)的空间。栈是从高地址向低地址增长的内存区域，主要用于存储函数调用时的返回地址、局部变量等。</p>
<h3 id="复位程序"><a href="#复位程序" class="headerlink" title="复位程序"></a>复位程序</h3><p>复位程序是系统启动后执行的第一个真正有意义的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">.thumb_func</span><br><span class="line">.align 2</span><br><span class="line">.globl Reset_Handler</span><br><span class="line">.type Reset_Handler, %function</span><br><span class="line">Reset_Handler:</span><br><span class="line">    /* 将数据段初始值从Flash复制到SRAM */</span><br><span class="line">    movs r1, #0</span><br><span class="line">    b LoopCopyDataInit</span><br><span class="line"></span><br><span class="line">CopyDataInit:</span><br><span class="line">    ldr r3, =_sidata</span><br><span class="line">    ldr r3, [r3, r1]</span><br><span class="line">    str r3, [r0, r1]</span><br><span class="line">    adds r1, r1, #4</span><br><span class="line"></span><br><span class="line">LoopCopyDataInit:</span><br><span class="line">    ldr r0, =_sdata</span><br><span class="line">    ldr r3, =_edata</span><br><span class="line">    adds r2, r0, r1</span><br><span class="line">    cmp r2, r3</span><br><span class="line">    bcc CopyDataInit</span><br><span class="line">    ldr r2, =_sbss</span><br><span class="line">    b LoopFillZerobss</span><br><span class="line"></span><br><span class="line">/* 将bss段清零 */</span><br><span class="line">FillZerobss:</span><br><span class="line">    movs r3, #0</span><br><span class="line">    str r3, [r2], #4</span><br><span class="line"></span><br><span class="line">LoopFillZerobss:</span><br><span class="line">    ldr r3, = _ebss</span><br><span class="line">    cmp r2, r3</span><br><span class="line">    bcc FillZerobss</span><br><span class="line"></span><br><span class="line">/* 调用主函数 */</span><br><span class="line">bl main</span><br><span class="line">bx lr</span><br></pre></td></tr></table></figure>

<p>复位处理程序的主要任务包括：</p>
<ol>
<li>初始化数据段：将已初始化的全局变量从Flash复制到RAM</li>
<li>清零bss段：将未初始化的全局变量所在的内存区域清零</li>
<li>调用主函数[main]</li>
</ol>
<p>注意这里的<code>.thumb_func</code>指令，它告诉汇编器该函数使用Thumb指令集。STM32 Cortex-M系列处理器主要使用Thumb指令集以提高代码密度。<br>简要介绍一下上面用到的汇编指令：</p>
<ul>
<li>movs r1, #0：将立即数0移动到寄存器r1中，并更新状态标志位</li>
<li>ldr r3, &#x3D;_sidata：将符号_sidata的地址加载到寄存器r3中</li>
<li>ldr r3, [r3, r1]：从内存地址(r3 + r1)处加载数据到寄存器r3</li>
<li>str r3, [r0, r1]：将寄存器r3中的值存储到内存地址(r0 + r1)处</li>
<li>str r3, [r2], #4：将寄存器r3中的值存储到地址r2处，然后将r2增加4</li>
</ul>
<h2 id="主程序分析"><a href="#主程序分析" class="headerlink" title="主程序分析"></a>主程序分析</h2><p>主程序文件[main.s]实现了LED控制逻辑：</p>
<h3 id="寄存器地址定义"><a href="#寄存器地址定义" class="headerlink" title="寄存器地址定义"></a>寄存器地址定义</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/* 定义GPIO寄存器地址 */</span><br><span class="line">.equ GPIOB_BASE,         0x40020400</span><br><span class="line">.equ GPIOB_MODER,        GPIOB_BASE + 0x00</span><br><span class="line">.equ GPIOB_OTYPER,       GPIOB_BASE + 0x04</span><br><span class="line">.equ GPIOB_OSPEEDR,      GPIOB_BASE + 0x08</span><br><span class="line">.equ GPIOB_PUPDR,        GPIOB_BASE + 0x0C</span><br><span class="line">.equ GPIOB_IDR,          GPIOB_BASE + 0x10</span><br><span class="line">.equ GPIOB_ODR,          GPIOB_BASE + 0x14</span><br><span class="line">.equ GPIOB_BSRR,         GPIOB_BASE + 0x18</span><br><span class="line">.equ GPIOB_LCKR,         GPIOB_BASE + 0x1C</span><br><span class="line">.equ GPIOB_AFRL,         GPIOB_BASE + 0x20</span><br><span class="line">.equ GPIOB_AFRH,         GPIOB_BASE + 0x24</span><br><span class="line"></span><br><span class="line">/* 定义RCC寄存器地址 */</span><br><span class="line">.equ RCC_BASE,           0x40023800</span><br><span class="line">.equ RCC_AHB1ENR,        RCC_BASE + 0x30</span><br></pre></td></tr></table></figure>

<p>这些地址定义对应STM32F407参考手册中的外设寄存器地址。通过直接操作这些寄存器，可以控制GPIO引脚的行为。</p>
<h3 id="主函数实现"><a href="#主函数实现" class="headerlink" title="主函数实现"></a>主函数实现</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">main:</span><br><span class="line">    /* 使能GPIOB时钟 */</span><br><span class="line">    ldr r0, =RCC_AHB1ENR</span><br><span class="line">    ldr r1, [r0]</span><br><span class="line">    orr r1, r1, #(1&lt;&lt;1)           /* 使能GPIOB时钟(第1位) */</span><br><span class="line">    str r1, [r0]</span><br><span class="line"></span><br><span class="line">    /* 配置PB2为输出模式 */</span><br><span class="line">    ldr r0, =GPIOB_MODER</span><br><span class="line">    ldr r1, [r0]</span><br><span class="line">    bic r1, r1, #(0x3 &lt;&lt; (LED_PIN * 2))  /* 清除PB2的模式位 */</span><br><span class="line">    orr r1, r1, #(0x1 &lt;&lt; (LED_PIN * 2))  /* 设置为输出模式 */</span><br><span class="line">    str r1, [r0]</span><br></pre></td></tr></table></figure>

<p>主函数首先使能GPIOB端口的时钟，因为STM32的所有外设都需要先使能时钟才能工作。然后配置PB2引脚为输出模式。可能你注意到了这里只配置了GPIO的时钟，并没有配置MCU的系统时钟，通过查阅F407的用户手册可以看到，HSION位在上电后默认开启。为了工程简单，使用默认的内部快速时钟即可。<br>里面有用到汇编指令：</p>
<ul>
<li>orr r1, r1, #(1&lt;&lt;1)：将寄存器 r1 与立即数 (1&lt;&lt;1) 进行按位或运算，结果存储在 r1 中，用于设置特定位（使能 GPIOB 时钟）</li>
<li>bic r1, r1, #(0x3 &lt;&lt; (LED_PIN * 2))：将寄存器 r1 与立即数 (0x3 &lt;&lt; (LED_PIN * 2)) 进行按位清除运算，用于清除 PB2 的模式位</li>
</ul>
<h3 id="LED控制循环"><a href="#LED控制循环" class="headerlink" title="LED控制循环"></a>LED控制循环</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">loop:</span><br><span class="line">    /* 点亮LED */</span><br><span class="line">    ldr r0, =GPIOB_BSRR</span><br><span class="line">    mov r1, #LED_PIN_MASK</span><br><span class="line">    str r1, [r0]</span><br><span class="line">    </span><br><span class="line">    /* 简单延时 */</span><br><span class="line">    bl delay</span><br><span class="line">    </span><br><span class="line">    /* 熄灭LED */</span><br><span class="line">    ldr r0, =GPIOB_BSRR</span><br><span class="line">    mov r1, #(LED_PIN_MASK &lt;&lt; 16)</span><br><span class="line">    str r1, [r0]</span><br><span class="line">    </span><br><span class="line">    /* 简单延时 */</span><br><span class="line">    bl delay</span><br><span class="line">    </span><br><span class="line">    /* 循环 */</span><br><span class="line">    b loop</span><br></pre></td></tr></table></figure>

<p>在这个循环中，我们通过操作BSRR(Bits Set&#x2F;Reset Register)寄存器来控制LED的亮灭。当写入低16位时，对应的引脚被置位(点亮)；当写入高16位时，对应的引脚被复位(熄灭)。</p>
<h3 id="延时函数"><a href="#延时函数" class="headerlink" title="延时函数"></a>延时函数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/* 延时函数 */</span><br><span class="line">delay:</span><br><span class="line">    push &#123;r4, lr&#125;</span><br><span class="line">    mov r4, #0xFF</span><br><span class="line">delay_outer:</span><br><span class="line">    mov r3, #0xFFF</span><br><span class="line">delay_inner:</span><br><span class="line">    subs r3, r3, #1</span><br><span class="line">    bne delay_inner</span><br><span class="line">    subs r4, r4, #1</span><br><span class="line">    bne delay_outer</span><br><span class="line">    pop &#123;r4, pc&#125;</span><br></pre></td></tr></table></figure>

<p>一个软件延时函数，通过嵌套循环消耗时间。</p>
<h2 id="链接脚本解析"><a href="#链接脚本解析" class="headerlink" title="链接脚本解析"></a>链接脚本解析</h2><p>链接脚本[linker.ld]定义了程序在内存中的布局：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(Reset_Handler)</span><br><span class="line"></span><br><span class="line">MEMORY</span><br><span class="line">&#123;</span><br><span class="line">    FLASH (rx)      : ORIGIN = 0x08000000, LENGTH = 512K</span><br><span class="line">    RAM (rwx)       : ORIGIN = 0x20000000, LENGTH = 128K</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ENTRY(Reset_Handler)</code>指定了程序的入口点是[Reset_Handler]函数。</p>
<p><code>MEMORY</code>部分定义了STM32F407的内存布局：</p>
<ul>
<li>Flash存储器从0x08000000开始，大小为512KB，具有读(read)和执行(execute)属性</li>
<li>RAM从0x20000000开始，大小为128KB，具有读(read)、写(write)和执行(execute)属性</li>
</ul>
<h3 id="段定义"><a href="#段定义" class="headerlink" title="段定义"></a>段定义</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SECTIONS</span><br><span class="line">&#123;</span><br><span class="line">    .text :</span><br><span class="line">    &#123;</span><br><span class="line">        KEEP(*(.isr_vector))</span><br><span class="line">        *(.text*)</span><br><span class="line">        *(.rodata*)</span><br><span class="line">        _etext = .;</span><br><span class="line">    &#125; &gt; FLASH</span><br><span class="line"></span><br><span class="line">    _sidata = .;</span><br><span class="line"></span><br><span class="line">    .data : AT (_sidata)</span><br><span class="line">    &#123;</span><br><span class="line">        _sdata = .;</span><br><span class="line">        *(.data*)</span><br><span class="line">        _edata = .;</span><br><span class="line">    &#125; &gt; RAM</span><br></pre></td></tr></table></figure>

<p>各段的作用：</p>
<ul>
<li><code>.text</code>段包含程序代码和只读数据，存储在Flash中</li>
<li><code>.data</code>段包含已初始化的全局变量，在Flash中存储但在RAM中运行</li>
<li><code>.bss</code>段包含未初始化的全局变量，全部清零后使用</li>
</ul>
<p><code>KEEP(*(.isr_vector))</code>确保向量表不会被链接器优化掉。</p>
<h2 id="Makefile构建系统"><a href="#Makefile构建系统" class="headerlink" title="Makefile构建系统"></a>Makefile构建系统</h2><p>我们的Makefile配置了完整的构建流程：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译器和工具</span></span><br><span class="line">CC = arm-none-eabi-gcc</span><br><span class="line">AS = arm-none-eabi-as</span><br><span class="line">LD = arm-none-eabi-ld</span><br><span class="line">OBJCOPY = arm-none-eabi-objcopy</span><br><span class="line">SIZE = arm-none-eabi-size</span><br><span class="line"></span><br><span class="line"><span class="comment"># 目标名称</span></span><br><span class="line">TARGET = stm32f407_blinky</span><br><span class="line"></span><br><span class="line"><span class="comment"># 源文件</span></span><br><span class="line">ASM_SOURCES = startup.s main.s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 链接脚本</span></span><br><span class="line">LINKER_SCRIPT = linker.ld</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对象文件</span></span><br><span class="line">OBJECTS = $(ASM_SOURCES:.s=.o)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 标志</span></span><br><span class="line">ASFLAGS = -mcpu=cortex-m4 -mthumb</span><br><span class="line">LDFLAGS = -T<span class="variable">$(LINKER_SCRIPT)</span> -Wl,-Map=<span class="variable">$(TARGET)</span>.map</span><br><span class="line">CPFLAGS = -O binary</span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认目标</span></span><br><span class="line"><span class="section">all: <span class="variable">$(TARGET)</span>.bin <span class="variable">$(TARGET)</span>.hex <span class="variable">$(TARGET)</span>.map</span></span><br></pre></td></tr></table></figure>

<p>关键点解释：</p>
<ul>
<li>使用ARM GCC工具链进行编译</li>
<li><code>-mcpu=cortex-m4 -mthumb</code>指定目标处理器和指令集</li>
<li><code>-T$(LINKER_SCRIPT) -Wl,-Map=$(TARGET).map</code>指定链接脚本并生成MAP文件</li>
<li>生成多种格式的输出文件：ELF、BIN、HEX</li>
</ul>
<h2 id="MAP文件解读"><a href="#MAP文件解读" class="headerlink" title="MAP文件解读"></a>MAP文件解读</h2><p>MAP文件[stm32f407_blinky.map]提供了详细的内存映射信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text           0x08000000      0x124</span><br><span class="line"> *(.isr_vector)</span><br><span class="line"> .isr_vector    0x08000000       0x8c startup.o</span><br><span class="line"> *(.text*)</span><br><span class="line"> .text          0x0800008c       0x44 startup.o</span><br><span class="line"> .text          0x080000d0       0x54 main.o</span><br></pre></td></tr></table></figure>

<p>从MAP文件可以看出：</p>
<ul>
<li>整个程序的代码段只有0x124(292字节)，非常小巧</li>
<li>向量表占用了0x8c(140字节)</li>
<li>启动代码占用了0x44(68字节)</li>
<li>主程序占用了0x54(84字节)</li>
</ul>
<p>这充分体现了纯汇编编程的高效性，相比C语言实现可以显著减小程序体积。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.stack          0x20000000      0x400</span><br><span class="line">.heap           0x20000000      0x200</span><br></pre></td></tr></table></figure>

<p>栈和堆都在RAM中分配，符合嵌入式系统的内存管理方式。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过这个最小化的STM32 LED闪烁项目，我们可以知道STM32工程的基本构成：</p>
<ol>
<li><strong>启动文件</strong>负责系统初始化和跳转到主程序</li>
<li><strong>主程序</strong>实现具体的业务逻辑</li>
<li><strong>链接脚本</strong>定义程序在内存中的布局</li>
<li><strong>Makefile</strong>自动化构建过程</li>
<li><strong>MAP文件</strong>提供内存使用的详细信息</li>
</ol>

                    
                </div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                    </div>
                    <div>
                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                        
                            <div class="next-post">
                                <a class="next"
                                   rel="next"
                                   href="/2025/12/01/Ozone%E6%95%B0%E6%8D%AE%E6%96%AD%E7%82%B9%E4%BD%BF%E7%94%A8/"
                                   title="Ozone数据断点使用"
                                >
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Ozone数据断点使用</span>
                                        <span class="post-nav-item">下一篇</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    






                
            </div>
        </div>

        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
    &copy;&nbsp;<span>2020</span>&nbsp;-&nbsp;2025
    
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">GaoSheng</a>
        
    </div>

    <!-- <div class="theme-info info-item">
        由&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;驱动&nbsp;&&nbsp;主题&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div> -->

    
        
        <div class="deploy-info info-item">
            
            本站由 <span class="tooltip" data-tooltip-content="GitHub Pages"><img src="/images/brands/github.png"></span> 提供部署服务
            
        </div>
    

    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        

        <!-- PC go comment -->
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        

        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
</main>





<!-- common js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/js/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/js/header-shrink.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/js/back2top.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/js/toggle-theme.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/js/code-block.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/js/main.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/js/libs/anime.min.js"></script>

<!-- local search -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/js/local-search.min.js"></script>


<!-- lazyload -->


<div class="">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-keep/4.2.5/js/post/post-helper.min.js"></script>

        <!-- toc -->
        

        <!-- copyright-info -->
        

        <!-- share -->
        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->


<!-- pjax -->



</body>
</html>
